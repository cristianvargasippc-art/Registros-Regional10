<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CELIDER DISTRITALES 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0E223A 0%, #457B9D 50%, #F8FCE0 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); overflow: hidden; animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .header { background: linear-gradient(135deg, #0E223A 0%, #457B9D 70%, #F8FCE0 100%); color: white; padding: 60px 40px; text-align: center; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; }
        .header-content { display: flex; align-items: center; justify-content: center; gap: 50px; flex-wrap: wrap; position: relative; z-index: 1; }
        h1 { font-size: 3.5em; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); letter-spacing: 2px; }
        .content { padding: 50px; }
        .section { margin-bottom: 40px; padding: 35px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; border-left: 6px solid #0E223A; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; }
        .section:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .section h2 { color: #0E223A; margin-bottom: 20px; font-size: 2em; }
        .section p { text-align: justify; line-height: 1.9; color: #2c3e50; font-size: 1.15em; }
        .button-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 40px; }
        .btn { padding: 25px 45px; font-size: 1.3em; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; transition: all 0.4s; box-shadow: 0 6px 20px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255,255,255,0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .btn:hover::before { width: 300px; height: 300px; }
        .btn span { position: relative; z-index: 1; }
        .btn-primary { background: linear-gradient(135deg, #0E223A 0%, #457B9D 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #457B9D 0%, #6a9ab8 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #0E223A 0%, #457B9D 100%); color: #F8FCE0; }
        .btn:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(0,0,0,0.3); }
        .btn-sm { padding: 10px 20px; font-size: 1em; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; max-width: 95%; margin: 50px auto; padding: 50px; border-radius: 20px; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .close { position: absolute; top: 20px; right: 30px; font-size: 2.5em; cursor: pointer; color: #999; transition: all 0.3s; }
        .close:hover { color: #457B9D; transform: rotate(90deg); }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 1.1em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 15px; border: 3px solid #ddd; border-radius: 10px; font-size: 1em; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #0E223A; box-shadow: 0 0 15px rgba(14,34,58,0.3); }
        .form-group textarea { min-height: 200px; font-family: monospace; font-size: 0.95em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border: 1px solid #ddd; font-size: 0.9em; }
        th { background: linear-gradient(135deg, #0E223A 0%, #457B9D 100%); color: white; font-weight: bold; }
        tr:hover { background: #f8f9fa; }
        .rubric-table { font-size: 0.85em; }
        .rubric-table input[type="number"] { width: 65px; padding: 6px; border: 2px solid #ddd; border-radius: 5px; text-align: center; }
        .alert { padding: 18px; margin-bottom: 20px; border-radius: 10px; font-weight: bold; font-size: 1em; border-left: 5px solid; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-color: #0c5460; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #856404; }
        .alert-success { background: #d4edda; color: #155724; border-color: #155724; }
        .commission-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin: 20px 0; }
        .commission-item { padding: 18px; background: white; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .commission-item:hover { background: #f0f4f8; transform: scale(1.03); }
        .commission-item.selected { background: linear-gradient(135deg, #0E223A 0%, #457B9D 100%); color: white; border-color: #0E223A; }
        .commission-item input[type="number"] { width: 100%; margin-top: 8px; padding: 6px; border: 2px solid rgba(255,255,255,0.5); border-radius: 5px; text-align: center; background: rgba(255,255,255,0.2); color: inherit; font-weight: bold; }
        .commission-item.selected input[type="number"] { background: rgba(255,255,255,0.25); color: white; border-color: rgba(255,255,255,0.6); }
        .commission-item:not(.selected) input[type="number"] { background: white; color: #0E223A; border-color: #ccc; }
        .file-upload-area { border: 4px dashed #0E223A; padding: 40px; text-align: center; border-radius: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); cursor: pointer; transition: all 0.3s; margin-bottom: 15px; }
        .file-upload-area:hover { border-color: #457B9D; background: linear-gradient(135deg, #c3cfe2 0%, #f5f7fa 100%); }
        .file-upload-area input { display: none; }
        .hidden { display: none; }
        .rubric-header { background: linear-gradient(135deg, #0E223A 0%, #457B9D 100%); color: white; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 20px; }
        .score-input { width: 60px; padding: 5px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
        .total-score { font-size: 1.2em; font-weight: bold; color: #0E223A; }
        .download-buttons { display: flex; gap: 15px; margin-top: 25px; justify-content: center; flex-wrap: wrap; }
        .welcome-section { background: linear-gradient(135deg, #0E223A 0%, #457B9D 70%, #F8FCE0 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .welcome-section h2 { font-size: 2.2em; margin-bottom: 15px; }
        .district-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 8px 22px; border-radius: 30px; font-size: 1.2em; font-weight: bold; margin-top: 8px; border: 2px solid rgba(255,255,255,0.5); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; margin-top: 25px; }
        .stat-card { background: rgba(255,255,255,0.15); padding: 22px; border-radius: 15px; text-align: center; border: 2px solid rgba(255,255,255,0.3); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.25); }
        .stat-number { font-size: 2.8em; font-weight: bold; display: block; margin-bottom: 8px; }
        .stat-label { font-size: 1em; opacity: 0.9; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #0E223A; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .loading-overlay p { color: white; font-size: 1.3em; font-weight: bold; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .search-box { width: 100%; padding: 18px; border: 3px solid #0E223A; border-radius: 12px; font-size: 1.2em; margin-bottom: 20px; }
        .search-box:focus { outline: none; box-shadow: 0 0 15px rgba(14,34,58,0.3); }
        .student-card { background: linear-gradient(135deg, #f5f7fa, #e8f0f7); border: 2px solid #c3cfe2; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 5px solid #0E223A; }
        .student-card h3 { color: #0E223A; margin-bottom: 8px; }
        .student-card .badge { display: inline-block; background: #0E223A; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; margin: 3px; }
        .student-card .badge.blue { background: #457B9D; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border: 3px solid #0E223A; background: white; color: #0E223A; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1em; transition: all 0.3s; }
        .tab-btn.active { background: #0E223A; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .upload-zone { border: 3px dashed #457B9D; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 20px; background: #f8fbff; cursor: pointer; }
        .upload-zone:hover { background: #e8f3ff; border-color: #0E223A; }
        .commission-card { background: white; border: 2px solid #c3cfe2; border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 6px solid #457B9D; }
        .commission-card h3 { color: #0E223A; font-size: 1.4em; margin-bottom: 8px; }
        .commission-card .nivel { display: inline-block; background: #457B9D; color: white; padding: 3px 12px; border-radius: 15px; font-size: 0.85em; margin-bottom: 10px; }
        .commission-card .categoria { display: inline-block; background: #0E223A; color: white; padding: 3px 12px; border-radius: 15px; font-size: 0.85em; margin-bottom: 10px; margin-left: 5px; }
        .topico-box { background: #f5f7fa; border-left: 4px solid #0E223A; padding: 12px 18px; border-radius: 0 8px 8px 0; margin-top: 10px; color: #2c3e50; font-style: italic; }
        .wa-btn { display: inline-block; background: #25D366; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; margin-top: 12px; transition: all 0.3s; }
        .wa-btn:hover { background: #128C7E; transform: scale(1.05); }
        .no-results { text-align: center; padding: 40px; color: #999; font-size: 1.2em; }
        .formato-info { background: #e8f0f7; border: 2px solid #457B9D; border-radius: 10px; padding: 15px; margin-bottom: 15px; font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p id="loadingText">Cargando...</p>
</div>

<div class="container">
    <div class="header">
        <div class="header-content">
            <h1>CELIDER DISTRITALES 2026</h1>
        </div>
    </div>

    <!-- P√ÅGINA PRINCIPAL -->
    <div class="content" id="mainContent">
        <div class="section">
            <h2>üìñ Misi√≥n</h2>
            <p>Fomentar el desarrollo de competencias diplom√°ticas, de liderazgo y trabajo colaborativo en los estudiantes de los distritos educativos 10-02, 10-04 y 10-06, mediante la simulaci√≥n de organismos internacionales, promoviendo el pensamiento cr√≠tico, la investigaci√≥n acad√©mica y el di√°logo constructivo para la resoluci√≥n de conflictos globales.</p>
        </div>
        <div class="section">
            <h2>üéØ Visi√≥n</h2>
            <p>Ser la plataforma educativa l√≠der en la Rep√∫blica Dominicana para la formaci√≥n de j√≥venes agentes de cambio, capaces de comprender y abordar los desaf√≠os internacionales del siglo XXI, fortaleciendo valores democr√°ticos, respeto a la diversidad, cooperaci√≥n internacional y compromiso con el desarrollo sostenible.</p>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" onclick="showLogin()"><span>üîê Acceso Administradores</span></button>
            <button class="btn btn-secondary" onclick="showStudentSearch()"><span>üîç Buscar Mi Asignaci√≥n</span></button>
            <button class="btn btn-success" onclick="showCommissions()"><span>üìã Ver Comisiones Disponibles</span></button>
        </div>
    </div>

    <!-- PANEL ADMIN -->
    <div class="content hidden" id="adminPanel">
        <div class="welcome-section">
            <h2>üéâ ¬°Bienvenido/a, <span id="welcomeUser"></span>!</h2>
            <div class="district-badge">üìç <span id="welcomeDistrict"></span></div>
            <p style="margin-top:15px; font-size:1.1em; line-height:1.7;">Sistema de gesti√≥n CELIDER Distritales 2026. Administra comisiones, listados, r√∫bricas y asignaciones.</p>
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-number" id="statStudents">0</span><span class="stat-label">Delegados</span></div>
                <div class="stat-card"><span class="stat-number" id="statCommissions">0</span><span class="stat-label">Comisiones Activas</span></div>
                <div class="stat-card"><span class="stat-number" id="statAssignments">0</span><span class="stat-label">Asignaciones</span></div>
            </div>
        </div>
        <h2 style="color:#0E223A; margin-bottom:20px;">üìã Panel de Control</h2>
        <div class="button-group">
            <button class="btn btn-primary" onclick="showUploadModal()"><span>üì§ Publicar Listado</span></button>
            <button class="btn btn-secondary" onclick="showConfigSection()"><span>‚öôÔ∏è Configurar Comisiones</span></button>
            <button class="btn btn-success" onclick="showWhatsAppLinks()"><span>üì± Links WhatsApp</span></button>
            <button class="btn btn-primary" onclick="showRubrics()"><span>üìä R√∫bricas</span></button>
            <button class="btn btn-secondary" onclick="showAssignments()"><span>üë• Ver Asignaciones</span></button>
            <button class="btn" style="background:#6c757d;color:white;" onclick="logout()"><span>üö™ Cerrar Sesi√≥n</span></button>
        </div>
    </div>
</div>

<!-- MODAL LOGIN -->
<div id="loginModal" class="modal">
    <div class="modal-content" style="max-width:500px;">
        <span class="close" onclick="closeModal('loginModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:25px;">üîê Iniciar Sesi√≥n</h2>
        <form onsubmit="login(); return false;">
            <div class="form-group"><label>Usuario:</label><input type="text" id="username" placeholder="Tu usuario"></div>
            <div class="form-group"><label>Contrase√±a:</label><input type="password" id="password" placeholder="Tu contrase√±a"></div>
            <div id="loginError" style="display:none; color:#c0392b; font-weight:bold; margin-bottom:15px; padding:10px; background:#fdecea; border-radius:8px;">‚ùå Usuario o contrase√±a incorrectos</div>
            <button type="submit" class="btn btn-primary" style="width:100%;"><span>Ingresar</span></button>
        </form>
    </div>
</div>

<!-- MODAL BUSCAR ASIGNACI√ìN -->
<div id="studentSearchModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('studentSearchModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:20px;">üîç Buscar Mi Asignaci√≥n</h2>
        <p style="color:#666; margin-bottom:20px;">Escribe tu nombre para encontrar tu comisi√≥n y delegaci√≥n asignada.</p>
        <input type="text" class="search-box" id="globalSearch" placeholder="üîé Escribe tu nombre aqu√≠..." oninput="filterGlobal()">
        <div id="globalResults">
            <div class="no-results">‚åõ Escribe tu nombre para buscar...</div>
        </div>
    </div>
</div>

<!-- MODAL COMISIONES -->
<div id="commissionsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('commissionsModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:25px;">üìã Comisiones Disponibles ‚Äî CELIDER 2026</h2>
        <div id="commissionsContent"></div>
    </div>
</div>

<!-- MODAL SUBIR LISTADO -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('uploadModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:20px;">üì§ Publicar Listado de Delegados</h2>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('tab-formato1')">üìã Formato 1 (con Comisi√≥n)</button>
            <button class="tab-btn" onclick="switchTab('tab-formato2')">üìã Formato 2 (por Distrito)</button>
        </div>

        <div id="tab-formato1" class="tab-content active">
            <div class="alert alert-info">
                <strong>üìå Formato 1:</strong> Columnas requeridas:<br>
                <code>Nombres &nbsp; Apellidos &nbsp; Delegacion &nbsp; Centro Educativo &nbsp; Comision</code>
            </div>
            <div class="formato-info">
                Nombres	Apellidos	Delegacion	Centro Educativo	Comision<br>
                Juan	P√©rez	Argentina	Liceo XYZ	FAO
            </div>

            <!-- OPCI√ìN A: ARCHIVO EXCEL -->
            <div class="upload-zone" onclick="document.getElementById('excelFile1').click()">
                <div style="font-size:2.5em;">üìÇ</div>
                <strong style="font-size:1.2em;">Seleccionar archivo Excel (.xlsx / .xls)</strong><br>
                <small style="color:#666;">Haz clic aqu√≠ para buscar el archivo en tu computadora</small>
                <input type="file" id="excelFile1" accept=".xlsx,.xls" style="display:none" onchange="readExcelFile(event,'format1')">
            </div>
            <div style="text-align:center; color:#999; margin: 10px 0; font-weight:bold;">‚Äî O ‚Äî</div>

            <!-- OPCI√ìN B: PEGAR -->
            <div class="form-group">
                <label>Pega el listado desde Excel:</label>
                <textarea id="pasteFormat1" placeholder="Copia las celdas en Excel (Ctrl+C) y pega aqu√≠ (Ctrl+V)..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="processFormat1()"><span>üì• Procesar y Publicar</span></button>
        </div>

        <div id="tab-formato2" class="tab-content">
            <div class="alert alert-info">
                <strong>üìå Formato 2:</strong> Columnas requeridas:<br>
                <code>Nombre Completo &nbsp; Centro Educativo &nbsp; Distrito</code>
            </div>
            <div class="formato-info">
                Nombre Completo	Centro Educativo	Distrito<br>
                Juan P√©rez	Liceo XYZ	10-02
            </div>

            <!-- OPCI√ìN A: ARCHIVO EXCEL -->
            <div class="upload-zone" onclick="document.getElementById('excelFile2').click()">
                <div style="font-size:2.5em;">üìÇ</div>
                <strong style="font-size:1.2em;">Seleccionar archivo Excel (.xlsx / .xls)</strong><br>
                <small style="color:#666;">Haz clic aqu√≠ para buscar el archivo en tu computadora</small>
                <input type="file" id="excelFile2" accept=".xlsx,.xls" style="display:none" onchange="readExcelFile(event,'format2')">
            </div>
            <div style="text-align:center; color:#999; margin: 10px 0; font-weight:bold;">‚Äî O ‚Äî</div>

            <!-- OPCI√ìN B: PEGAR -->
            <div class="form-group">
                <label>Pega el listado desde Excel:</label>
                <textarea id="pasteFormat2" placeholder="Copia las celdas en Excel (Ctrl+C) y pega aqu√≠ (Ctrl+V)..."></textarea>
            </div>
            <div class="alert alert-warning">‚ö†Ô∏è Aseg√∫rate de haber configurado las comisiones activas primero. Los estudiantes ser√°n distribuidos autom√°ticamente con pa√≠ses √∫nicos por comisi√≥n.</div>
            <button class="btn btn-primary" onclick="processFormat2()"><span>üì• Procesar y Publicar</span></button>
        </div>

        <div id="uploadResult" style="margin-top:20px;"></div>
    </div>
</div>

<!-- MODAL CONFIG COMISIONES -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('configModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:10px;">‚öôÔ∏è Configurar Comisiones</h2>
        <p style="color:#666; margin-bottom:20px;">Selecciona las comisiones que simular√°s y escribe el n√∫mero de delegados para cada una.</p>
        <div class="commission-selector" id="commissionSelector"></div>
        <div style="display:flex; gap:15px; margin-top:20px; flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="saveConfiguration()"><span>üíæ Guardar Configuraci√≥n</span></button>
            <button class="btn" style="background:#c0392b;color:white;" onclick="clearCommissions()"><span>üóëÔ∏è Limpiar Selecci√≥n</span></button>
        </div>
    </div>
</div>

<!-- MODAL WHATSAPP -->
<div id="whatsappModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('whatsappModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:20px;">üì± Links de WhatsApp</h2>
        <div id="whatsappLinksForm"></div>
        <button class="btn btn-primary" onclick="saveWhatsAppLinks()"><span>üíæ Guardar Links</span></button>
    </div>
</div>

<!-- MODAL R√öBRICAS -->
<div id="rubricsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('rubricsModal')">&times;</span>
        <div id="rubricsContent"></div>
    </div>
</div>

<!-- MODAL ASIGNACIONES -->
<div id="assignmentsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('assignmentsModal')">&times;</span>
        <h2 style="color:#0E223A; margin-bottom:20px;">üë• Asignaciones por Comisi√≥n</h2>
        <div id="assignmentsContent"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ===================== FIREBASE =====================
const firebaseConfig = {
    apiKey: "AIzaSyA2HicfJnEoNOdgjfERIgkiJ0GA260HyLA",
    authDomain: "celider-distritales-f8753.firebaseapp.com",
    databaseURL: "https://celider-distritales-f8753-default-rtdb.firebaseio.com",
    projectId: "celider-distritales-f8753",
    storageBucket: "celider-distritales-f8753.firebasestorage.app",
    messagingSenderId: "252428103373",
    appId: "1:252428103373:web:6a209f9de105f8474d0384"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===================== USUARIOS =====================
const users = {
    'CUENTA1':       { password: 'DISTRITO 10-02', district: '10-02' },
    'CUENTA2':       { password: 'DISTRITO 10-04', district: '10-04' },
    'DIRECTIVA10-02':{ password: 'CELIDER10-02',   district: '10-02' },
    'DIEGO':         { password: 'REYES 123DIEGO',  district: 'ADMIN' }
};

// ===================== COMISIONES =====================
const commissions = [
    {
        id:'fao', name:'FAO', nivel:'B√°sico', categoria:'Desarrollo Sostenible',
        fullName:'FAO ‚Äì Organizaci√≥n de las Naciones Unidas para la Alimentaci√≥n y la Agricultura',
        topic:'Impactos del cambio clim√°tico en la producci√≥n agr√≠cola familiar y la seguridad alimentaria en el Caribe.',
        defaultMax:60, type:'delegaciones'
    },
    {
        id:'oms', name:'OMS', nivel:'B√°sico', categoria:'Salud P√∫blica',
        fullName:'OMS ‚Äì Organizaci√≥n Mundial de la Salud',
        topic:'Acceso equitativo a vacunas y medicamentos en pa√≠ses de ingreso bajo y medio.',
        defaultMax:60, type:'delegaciones'
    },
    {
        id:'unicef', name:'UNICEF', nivel:'B√°sico', categoria:'Desarrollo Humano',
        fullName:'UNICEF ‚Äì Fondo de las Naciones Unidas para la Infancia',
        topic:'Protecci√≥n de los derechos de los ni√±os en el contexto de la migraci√≥n infantil en Am√©rica Central.',
        defaultMax:60, type:'delegaciones'
    },
    {
        id:'uit', name:'UIT', nivel:'Intermedio', categoria:'Tecnolog√≠a',
        fullName:'UIT ‚Äì Uni√≥n Internacional de Telecomunicaciones',
        topic:'Cooperaci√≥n internacional frente a la vulneraci√≥n de derechos digitales en ni√±os y adolescentes.',
        defaultMax:60, type:'delegaciones'
    },
    {
        id:'unesco', name:'UNESCO', nivel:'Intermedio', categoria:'Cultura y Patrimonio',
        fullName:'UNESCO ‚Äì Organizaci√≥n de las Naciones Unidas para la Educaci√≥n, la Ciencia y la Cultura',
        topic:'Preservaci√≥n del patrimonio cultural inmaterial frente al turismo masivo y la mercantilizaci√≥n digital.',
        defaultMax:60, type:'delegaciones'
    },
    {
        id:'oit', name:'OIT', nivel:'Intermedio', categoria:'Comercio y Trabajo',
        fullName:'OIT ‚Äì Organizaci√≥n Internacional del Trabajo',
        topic:'Responsabilidad corporativa ante la explotaci√≥n laboral de ni√±os en la cadena de suministro global.',
        defaultMax:60, type:'delegaciones'
    },
    {
        id:'bandung', name:'1955', nivel:'Intermedio', categoria:'Comisi√≥n Hist√≥rica',
        fullName:'1955 ‚Äì Conferencia de Bandung',
        topic:'Descolonizaci√≥n, cooperaci√≥n sur-sur y el nacimiento del movimiento de los no alineados.',
        defaultMax:58, type:'delegaciones'
    },
    {
        id:'cij', name:'CIJ', nivel:'Avanzado', categoria:'Derecho Internacional',
        fullName:'CIJ ‚Äì Corte Internacional de Justicia',
        topic:'Opini√≥n consultiva: Legalidad de la explotaci√≥n de recursos naturales en zonas marinas continentales en disputa territorial.',
        defaultMax:15, type:'magistrados'
    },
    {
        id:'interpol', name:'INTERPOL', nivel:'Avanzado', categoria:'Seguridad Internacional',
        fullName:'INTERPOL ‚Äì Organizaci√≥n Internacional de Polic√≠a Criminal',
        topic:'Caso para preparar por la Secretar√≠a General Acad√©mica del Modelo Distrital en coordinaci√≥n con el Club Distrital y Regional correspondiente.',
        defaultMax:50, type:'agentes'
    },
    {
        id:'otan', name:'OTAN', nivel:'Avanzado', categoria:'Geopol√≠tica y Defensa',
        fullName:'OTAN ‚Äì Organizaci√≥n del Tratado del Atl√°ntico Norte',
        topic:'Cooperaci√≥n en defensa ante amenazas h√≠bridas, ciberataques y desinformaci√≥n en escenarios de guerra contempor√°nea.',
        defaultMax:64, type:'delegaciones'
    },
    {
        id:'oas', name:'OAS', nivel:'Advanced', categoria:'To simulate in English',
        fullName:'OAS ‚Äì Permanent Council of the Organization of American States',
        topic:'Strengthening democratic institutions and electoral integrity in Latin America and the Caribbean.',
        defaultMax:35, type:'states'
    }
];

// ===================== PA√çSES (195 pa√≠ses, sin repetir por comisi√≥n) =====================
const allCountries = [
    'Afghanistan','Albania','Algeria','Andorra','Angola','Antigua and Barbuda','Argentina','Armenia',
    'Australia','Austria','Azerbaijan','Bahamas','Bahrain','Bangladesh','Barbados','Belarus','Belgium',
    'Belize','Benin','Bhutan','Bolivia','Bosnia and Herzegovina','Botswana','Brazil','Brunei',
    'Bulgaria','Burkina Faso','Burundi','Cabo Verde','Cambodia','Cameroon','Canada','Central African Republic',
    'Chad','Chile','China','Colombia','Comoros','Congo','Costa Rica','Croatia','Cuba','Cyprus',
    'Czech Republic','Denmark','Djibouti','Dominica','Dominican Republic','Ecuador','Egypt','El Salvador',
    'Equatorial Guinea','Eritrea','Estonia','Eswatini','Ethiopia','Fiji','Finland','France','Gabon',
    'Gambia','Georgia','Germany','Ghana','Greece','Grenada','Guatemala','Guinea','Guinea-Bissau',
    'Guyana','Haiti','Honduras','Hungary','Iceland','India','Indonesia','Iran','Iraq','Ireland',
    'Israel','Italy','Jamaica','Japan','Jordan','Kazakhstan','Kenya','Kiribati','Kuwait','Kyrgyzstan',
    'Laos','Latvia','Lebanon','Lesotho','Liberia','Libya','Liechtenstein','Lithuania','Luxembourg',
    'Madagascar','Malawi','Malaysia','Maldives','Mali','Malta','Marshall Islands','Mauritania',
    'Mauritius','Mexico','Micronesia','Moldova','Monaco','Mongolia','Montenegro','Morocco','Mozambique',
    'Myanmar','Namibia','Nauru','Nepal','Netherlands','New Zealand','Nicaragua','Niger','Nigeria',
    'North Korea','North Macedonia','Norway','Oman','Pakistan','Palau','Palestine','Panama',
    'Papua New Guinea','Paraguay','Peru','Philippines','Poland','Portugal','Qatar','Romania','Russia',
    'Rwanda','Saint Kitts and Nevis','Saint Lucia','Saint Vincent','Samoa','San Marino','Sao Tome',
    'Saudi Arabia','Senegal','Serbia','Seychelles','Sierra Leone','Singapore','Slovakia','Slovenia',
    'Solomon Islands','Somalia','South Africa','South Korea','South Sudan','Spain','Sri Lanka','Sudan',
    'Suriname','Sweden','Switzerland','Syria','Taiwan','Tajikistan','Tanzania','Thailand','Timor-Leste',
    'Togo','Tonga','Trinidad and Tobago','Tunisia','Turkey','Turkmenistan','Tuvalu','Uganda','Ukraine',
    'United Arab Emirates','United Kingdom','United States','Uruguay','Uzbekistan','Vanuatu','Venezuela',
    'Vietnam','Yemen','Zambia','Zimbabwe'
];

// Magistrado names pool
const magistradoTitles = ['S.E. Juez Presidente','S.E. Juez Vicepresidente','S.E. Magistrado','S.E. Magistrada'];

// ===================== ESTADO GLOBAL =====================
let currentUser = null;
let assignments = [];
let selectedCommissions = [];
let customLimits = {};
let whatsappLinks = {};
let allAssignments = []; // para b√∫squeda p√∫blica

// ===================== UI UTILS =====================
function showLoading(text='Cargando...') {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').style.display = 'flex';
}
function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display='none'; };

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// ===================== LOGIN =====================
function showLogin() { document.getElementById('loginModal').style.display='block'; }
function logout() {
    currentUser = null;
    document.getElementById('mainContent').classList.remove('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
}

function login() {
    const u = document.getElementById('username').value.trim().toUpperCase();
    const p = document.getElementById('password').value.trim().toUpperCase();
    const err = document.getElementById('loginError');
    if(users[u] && users[u].password.toUpperCase() === p) {
        currentUser = { username: u, district: users[u].district };
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('welcomeUser').textContent = u;
        document.getElementById('welcomeDistrict').textContent = currentUser.district==='ADMIN' ? 'Administrador General' : 'Distrito '+currentUser.district;
        closeModal('loginModal');
        err.style.display='none';
        document.getElementById('username').value='';
        document.getElementById('password').value='';
        loadAdminData();
    } else {
        err.style.display='block';
        document.getElementById('password').value='';
    }
}

// ===================== BUSCAR ASIGNACI√ìN (P√öBLICO) =====================
function showStudentSearch() {
    document.getElementById('studentSearchModal').style.display='block';
    document.getElementById('globalSearch').value='';
    document.getElementById('globalResults').innerHTML = '<div class="no-results">‚åõ Escribe tu nombre para buscar...</div>';
    // Cargar asignaciones p√∫blicas de Firebase
    showLoading('Cargando asignaciones...');
    db.ref('publicAssignments').once('value').then(snap => {
        allAssignments = snap.val() || [];
        hideLoading();
        if(allAssignments.length === 0) {
            document.getElementById('globalResults').innerHTML = '<div class="no-results">üì≠ A√∫n no se han publicado asignaciones.</div>';
        }
    }).catch(()=>{
        hideLoading();
        document.getElementById('globalResults').innerHTML = '<div class="no-results">‚ö†Ô∏è Error al cargar. Verifica tu conexi√≥n.</div>';
    });
}

function filterGlobal() {
    const q = document.getElementById('globalSearch').value.trim().toLowerCase();
    const container = document.getElementById('globalResults');
    if(!q || q.length < 2) {
        container.innerHTML = '<div class="no-results">‚åõ Escribe al menos 2 letras...</div>';
        return;
    }
    const results = allAssignments.filter(a =>
        (a.name||'').toLowerCase().includes(q) ||
        (a.school||'').toLowerCase().includes(q)
    );
    if(results.length === 0) {
        container.innerHTML = '<div class="no-results">üîç No se encontraron resultados para "<strong>'+q+'</strong>"</div>';
        return;
    }
    container.innerHTML = results.map(s => {
        const comm = commissions.find(c=>c.id===s.commission);
        const waLink = whatsappLinks[s.commission] ? `<a href="${whatsappLinks[s.commission]}" target="_blank" class="wa-btn">üì± Unirse al grupo</a>` : '';
        return `
        <div class="student-card">
            <h3>üë§ ${s.name}</h3>
            <span class="badge">${s.school||''}</span>
            ${s.district ? `<span class="badge blue">Distrito ${s.district}</span>` : ''}
            <br style="margin:8px 0;">
            <strong style="color:#0E223A;">üèõÔ∏è Comisi√≥n:</strong> ${comm ? comm.fullName : s.commissionName || s.commission}<br>
            <strong style="color:#457B9D;">üåç Delegaci√≥n:</strong> ${s.delegation}<br>
            ${waLink}
        </div>`;
    }).join('');
}

// ===================== VER COMISIONES =====================
function showCommissions() {
    // Cargar comisiones activas desde Firebase
    showLoading();
    db.ref('selectedCommissions').once('value').then(snap => {
        const active = snap.val() || commissions.map(c=>c.id);
        hideLoading();
        const content = document.getElementById('commissionsContent');
        const toShow = commissions.filter(c => active.includes(c.id));
        if(toShow.length === 0) {
            content.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è A√∫n no se han configurado las comisiones activas.</div>';
        } else {
            content.innerHTML = toShow.map((c,i) => `
                <div class="commission-card">
                    <h3>${i+1}. ${c.fullName}</h3>
                    <span class="nivel">üìä ${c.nivel}</span>
                    <span class="categoria">üìÅ ${c.categoria}</span>
                    <div class="topico-box">üìå <strong>T√≥pico:</strong> ${c.topic}</div>
                </div>
            `).join('');
        }
        document.getElementById('commissionsModal').style.display='block';
    }).catch(()=>{ hideLoading(); });
}

// ===================== CONFIGURAR COMISIONES (ADMIN) =====================
function showConfigSection() {
    const sel = document.getElementById('commissionSelector');
    sel.innerHTML = commissions.map(c => {
        const isSelected = selectedCommissions.includes(c.id);
        const limit = customLimits[c.id] || '';
        return `
        <div class="commission-item ${isSelected?'selected':''}" id="ci_${c.id}" onclick="toggleCommission('${c.id}')">
            <strong>${c.name}</strong><br>
            <small>${c.nivel}</small><br>
            <small style="font-size:0.8em;">${c.categoria}</small>
            <input type="number" id="limit_${c.id}" value="${limit}" min="1" max="9999"
                onclick="event.stopPropagation()"
                oninput="customLimits['${c.id}']=parseInt(this.value)||9999"
                placeholder="# delegados">
        </div>`;
    }).join('');
    document.getElementById('configModal').style.display='block';
}

function toggleCommission(id) {
    const i = selectedCommissions.indexOf(id);
    if(i>-1) selectedCommissions.splice(i,1);
    else selectedCommissions.push(id);
    const el = document.getElementById('ci_'+id);
    el.classList.toggle('selected');
}

function clearCommissions() {
    if(!confirm('¬øLimpiar todas las comisiones seleccionadas?')) return;
    selectedCommissions = [];
    customLimits = {};
    showLoading('Limpiando...');
    db.ref('selectedCommissions').set([])
    .then(()=> db.ref('customLimits').set({}))
    .then(()=>{
        hideLoading();
        updateStats();
        // Refrescar visual
        document.querySelectorAll('.commission-item').forEach(el => el.classList.remove('selected'));
        alert('‚úÖ Comisiones limpiadas. Ya puedes seleccionar las que necesites.');
    }).catch(e=>{ hideLoading(); alert('Error: '+e.message); });
}

function saveConfiguration() {
    if(selectedCommissions.length===0){
        if(!confirm('No tienes comisiones seleccionadas. ¬øGuardar vac√≠o?')) return;
    }
    showLoading('Guardando...');
    db.ref('selectedCommissions').set(selectedCommissions)
    .then(()=> db.ref('customLimits').set(customLimits))
    .then(()=>{ hideLoading(); alert('‚úÖ Configuraci√≥n guardada'); closeModal('configModal'); updateStats(); })
    .catch(e=>{ hideLoading(); alert('Error: '+e.message); });
}

// ===================== ASIGNACI√ìN DE PA√çSES (SIN REPETIR POR COMISI√ìN) =====================
function assignCountriesUnique(studentsArr, activeComms) {
    // Para cada comisi√≥n, tener un pool de pa√≠ses barajados y sin repetir
    const commPools = {};
    activeComms.forEach(comm => {
        const shuffled = [...allCountries].sort(()=>Math.random()-0.5);
        commPools[comm.id] = { pool: shuffled, index: 0 };
    });

    // Contador de estudiantes por comisi√≥n
    const commCounts = {};
    activeComms.forEach(c => commCounts[c.id] = 0);

    return studentsArr.map((student, idx) => {
        // Distribuir en round-robin respetando l√≠mites
        let assignedComm = null;
        for(let attempt = 0; attempt < activeComms.length; attempt++) {
            const comm = activeComms[(idx + attempt) % activeComms.length];
            const limit = customLimits[comm.id] || 9999;
            if(commCounts[comm.id] < limit) {
                assignedComm = comm;
                break;
            }
        }
        if(!assignedComm) assignedComm = activeComms[idx % activeComms.length];

        commCounts[assignedComm.id]++;

        let delegation = '';
        if(assignedComm.type === 'magistrados') {
            const titles = ['S.E. Magistrado/a','S.E. Juez/a','S.E. √Årbitro/a'];
            delegation = titles[commCounts[assignedComm.id] % titles.length] + ' ' + (student.name||'').split(' ').slice(-1)[0];
        } else if(assignedComm.type === 'agentes') {
            delegation = 'Agente ' + (student.name||'').split(' ')[0];
        } else {
            const pool = commPools[assignedComm.id];
            if(pool.index < pool.pool.length) {
                delegation = pool.pool[pool.index++];
            } else {
                delegation = allCountries[Math.floor(Math.random()*allCountries.length)];
            }
        }

        return {
            name: student.name || student['Nombre Completo'] || '',
            school: student.school || student['Centro Educativo'] || '',
            district: student.district || student['Distrito'] || '',
            commission: assignedComm.id,
            commissionName: assignedComm.fullName,
            delegation: delegation,
            attendance: '',
            scores: {},
            total: 0,
            regional: false
        };
    });
}

// ===================== LEER ARCHIVO EXCEL =====================
function readExcelFile(event, targetFormat) {
    const file = event.target.files[0];
    if(!file) return;

    showLoading('Leyendo archivo Excel...');
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            // Convertir a TSV para que los procesadores existentes lo puedan usar
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const tsv = rows.map(row => row.join('\t')).join('\n');

            if(targetFormat === 'format1') {
                document.getElementById('pasteFormat1').value = tsv;
                hideLoading();
                // Mostrar nombre del archivo
                document.querySelector('#tab-formato1 .upload-zone strong').textContent = '‚úÖ Archivo cargado: ' + file.name;
                document.querySelector('#tab-formato1 .upload-zone small').textContent = rows.length - 1 + ' filas detectadas. Haz clic en "Procesar y Publicar".';
            } else {
                document.getElementById('pasteFormat2').value = tsv;
                hideLoading();
                document.querySelector('#tab-formato2 .upload-zone strong').textContent = '‚úÖ Archivo cargado: ' + file.name;
                document.querySelector('#tab-formato2 .upload-zone small').textContent = rows.length - 1 + ' filas detectadas. Haz clic en "Procesar y Publicar".';
            }
        } catch(err) {
            hideLoading();
            alert('‚ùå Error al leer el archivo: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

// ===================== PROCESAR FORMATO 1 =====================
// Nombres | Apellidos | Delegacion | Centro Educativo | Comision
function processFormat1() {
    const raw = document.getElementById('pasteFormat1').value.trim();
    if(!raw){ alert('‚ö†Ô∏è Pega o carga el listado primero'); return; }

    const lines = raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').map(l=>l.trim()).filter(l=>l);
    const startIdx = lines[0].toLowerCase().includes('nombre') || lines[0].toLowerCase().includes('apellido') ? 1 : 0;

    const parsed = [];
    for(let i=startIdx; i<lines.length; i++) {
        const cols = lines[i].split('\t');
        if(cols.length < 2) continue;
        const nombres    = (cols[0]||'').trim();
        const apellidos  = (cols[1]||'').trim();
        const delegacion = (cols[2]||'').trim();
        const centro     = (cols[3]||'').trim();
        const commNom    = (cols[4]||'').trim().toUpperCase();

        const comm = commissions.find(c =>
            c.id.toUpperCase()===commNom ||
            c.name.toUpperCase()===commNom ||
            commNom.includes(c.name.toUpperCase())
        );

        const fullName = apellidos ? nombres+' '+apellidos : nombres;
        if(!fullName.trim()) continue;

        parsed.push({
            name: fullName.trim(),
            school: centro,
            district: '',
            commission: comm ? comm.id : commNom.toLowerCase(),
            commissionName: comm ? comm.fullName : commNom,
            delegation: delegacion,
            attendance: '', scores: {}, total: 0, regional: false
        });
    }

    if(parsed.length===0){ alert('‚ùå No se pudieron leer datos. Verifica el formato.'); return; }

    showLoading('Publicando '+parsed.length+' delegados...');
    db.ref('publicAssignments').once('value').then(snap => {
        const existing = snap.val() || [];
        return db.ref('publicAssignments').set([...existing, ...parsed]);
    }).then(()=>{
        hideLoading();
        document.getElementById('uploadResult').innerHTML = `<div class="alert alert-success">‚úÖ <strong>${parsed.length} delegados publicados</strong> correctamente.</div>`;
        assignments = [...assignments, ...parsed];
        updateStats();
    }).catch(e=>{ hideLoading(); alert('Error: '+e.message); });
}

// ===================== PROCESAR FORMATO 2 =====================
// Nombre Completo | Centro Educativo | Distrito
function processFormat2() {
    const raw = document.getElementById('pasteFormat2').value.trim();
    if(!raw){ alert('‚ö†Ô∏è Pega o carga el listado primero'); return; }
    if(selectedCommissions.length===0){ alert('‚ö†Ô∏è Configura las comisiones activas primero en ‚öôÔ∏è Configurar Comisiones'); return; }

    const lines = raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').map(l=>l.trim()).filter(l=>l);
    const startIdx = lines[0].toLowerCase().includes('nombre') ? 1 : 0;

    const parsed = [];
    for(let i=startIdx; i<lines.length; i++) {
        const cols = lines[i].split('\t');
        if(cols.length < 1 || !cols[0].trim()) continue;
        parsed.push({
            name: (cols[0]||'').trim(),
            school: (cols[1]||'').trim(),
            district: (cols[2]||'').trim()
        });
    }

    if(parsed.length===0){ alert('‚ùå No se pudieron leer datos.'); return; }

    const activeComms = commissions.filter(c => selectedCommissions.includes(c.id));
    const withAssignments = assignCountriesUnique(parsed, activeComms);

    showLoading('Publicando '+withAssignments.length+' delegados...');
    db.ref('publicAssignments').once('value').then(snap => {
        const existing = snap.val() || [];
        return db.ref('publicAssignments').set([...existing, ...withAssignments]);
    }).then(()=>{
        hideLoading();
        document.getElementById('uploadResult').innerHTML = `<div class="alert alert-success">‚úÖ <strong>${withAssignments.length} delegados publicados</strong> en ${activeComms.length} comisiones con pa√≠ses √∫nicos.</div>`;
        assignments = [...assignments, ...withAssignments];
        updateStats();
    }).catch(e=>{ hideLoading(); alert('Error: '+e.message); });
}

function showUploadModal() {
    document.getElementById('uploadResult').innerHTML='';
    document.getElementById('uploadModal').style.display='block';
}

// ===================== WHATSAPP =====================
function showWhatsAppLinks() {
    const form = document.getElementById('whatsappLinksForm');
    const active = selectedCommissions.length>0 ? commissions.filter(c=>selectedCommissions.includes(c.id)) : commissions;
    form.innerHTML = active.map(c=>`
        <div class="form-group">
            <label>${c.name} ‚Äì ${c.fullName.split('‚Äì')[0].trim()}:</label>
            <input type="url" id="wa_${c.id}" value="${whatsappLinks[c.id]||''}" placeholder="https://chat.whatsapp.com/...">
        </div>`).join('');
    document.getElementById('whatsappModal').style.display='block';
}

function saveWhatsAppLinks() {
    const active = selectedCommissions.length>0 ? commissions.filter(c=>selectedCommissions.includes(c.id)) : commissions;
    active.forEach(c=>{ const i=document.getElementById('wa_'+c.id); if(i) whatsappLinks[c.id]=i.value; });
    showLoading('Guardando...');
    db.ref('whatsappLinks').set(whatsappLinks)
    .then(()=>{ hideLoading(); alert('‚úÖ Links guardados'); closeModal('whatsappModal'); })
    .catch(e=>{ hideLoading(); alert('Error: '+e.message); });
}

// ===================== R√öBRICAS =====================
const rubricCriteria = [
    {name:'Investigaci√≥n acad√©mica', max:15},
    {name:'Pensamiento cr√≠tico', max:15},
    {name:'Oratoria', max:10},
    {name:'Argumentaci√≥n', max:10},
    {name:'Redacci√≥n', max:10},
    {name:'Negociaci√≥n', max:10},
    {name:'Resoluci√≥n de conflictos', max:10},
    {name:'Liderazgo', max:10},
    {name:'Colaboraci√≥n', max:10}
];

function showRubrics() {
    showLoading();
    db.ref('publicAssignments').once('value').then(snap=>{
        const allA = snap.val() || [];
        hideLoading();
        const content = document.getElementById('rubricsContent');
        const activeComms = selectedCommissions.length>0 ? commissions.filter(c=>selectedCommissions.includes(c.id)) : commissions;
        let html = '';
        activeComms.forEach(comm=>{
            let students = currentUser.district==='ADMIN'
                ? allA.filter(a=>a.commission===comm.id)
                : allA.filter(a=>a.commission===comm.id && a.district===currentUser.district);
            if(students.length===0) return;
            html += `<div class="rubric-header"><h2>üìä R√öBRICA ‚Äî ${comm.name}</h2><p style="font-size:0.9em;margin-top:5px;">${comm.fullName}</p></div>
            <div style="overflow-x:auto;"><table class="rubric-table"><thead><tr>
                <th>Nombre</th><th>Delegaci√≥n</th>
                ${currentUser.district==='ADMIN'?'<th>Distrito</th>':''}
                <th>P&V</th><th>P</th><th>A</th>
                ${rubricCriteria.map(c=>`<th>${c.name}<br><small>(${c.max})</small></th>`).join('')}
                <th>Total</th><th>Regional</th>
            </tr></thead><tbody>`;
            students.forEach((s,si)=>{
                html += `<tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.delegation}</td>
                    ${currentUser.district==='ADMIN'?`<td>${s.district||''}</td>`:''}
                    <td><input type="radio" name="att_${si}_${comm.id}" value="PV" ${s.attendance==='PV'?'checked':''}></td>
                    <td><input type="radio" name="att_${si}_${comm.id}" value="P" ${s.attendance==='P'?'checked':''}></td>
                    <td><input type="radio" name="att_${si}_${comm.id}" value="A" ${s.attendance==='A'?'checked':''}></td>
                    ${rubricCriteria.map(c=>`<td><input type="number" class="score-input" min="0" max="${c.max}" step="0.5" value="${s.scores&&s.scores[c.name]||''}"></td>`).join('')}
                    <td class="total-score" id="tot_${si}_${comm.id}">${s.total||0}</td>
                    <td><input type="checkbox" ${s.regional?'checked':''} style="width:22px;height:22px;"></td>
                </tr>`;
            });
            html += `</tbody></table></div><br>`;
        });
        html += `<div class="download-buttons">
            <button class="btn btn-success btn-sm" onclick="downloadRubricsExcel()"><span>üì• Descargar Excel</span></button>
        </div>`;
        content.innerHTML = html || '<div class="alert alert-warning">No hay delegados cargados a√∫n.</div>';
        document.getElementById('rubricsModal').style.display='block';
    }).catch(()=>hideLoading());
}

function downloadRubricsExcel() {
    db.ref('publicAssignments').once('value').then(snap=>{
        const allA = snap.val()||[];
        const wb = XLSX.utils.book_new();
        commissions.forEach(comm=>{
            const students = currentUser.district==='ADMIN'
                ? allA.filter(a=>a.commission===comm.id)
                : allA.filter(a=>a.commission===comm.id&&a.district===currentUser.district);
            if(students.length===0) return;
            const data = [
                ['R√öBRICA DE EVALUACI√ìN ‚Äî '+comm.fullName],
                [],
                ['Nombre','Delegaci√≥n','Distrito','Asistencia',...rubricCriteria.map(c=>c.name),'Total','Regional']
            ];
            students.forEach(s=>{
                data.push([s.name,s.delegation,s.district||'',s.attendance||'',...rubricCriteria.map(c=>(s.scores&&s.scores[c.name])||0),s.total||0,s.regional?'S√ç':'NO']);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), comm.name);
        });
        XLSX.writeFile(wb,'Rubricas_CELIDER_'+new Date().toISOString().split('T')[0]+'.xlsx');
    });
}

// ===================== VER ASIGNACIONES (ADMIN) =====================
function showAssignments() {
    showLoading();
    db.ref('publicAssignments').once('value').then(snap=>{
        const allA = snap.val()||[];
        hideLoading();
        const content = document.getElementById('assignmentsContent');
        let html = '';

        // Bot√≥n para limpiar todas las asignaciones
        html += `<div style="text-align:right;margin-bottom:15px;">
            <button class="btn btn-sm" style="background:#c0392b;color:white;" onclick="clearAllAssignments()"><span>üóëÔ∏è Limpiar todo</span></button>
        </div>`;

        const activeComms = selectedCommissions.length>0 ? commissions.filter(c=>selectedCommissions.includes(c.id)) : commissions;
        activeComms.forEach(comm=>{
            const students = allA.filter(a=>a.commission===comm.id);
            if(students.length===0) return;
            html += `<div class="section"><h3 style="color:#0E223A;">${comm.fullName} <span style="background:#457B9D;color:white;padding:3px 10px;border-radius:15px;font-size:0.8em;">${students.length}</span></h3>
            <table><thead><tr><th>Nombre</th><th>Centro</th><th>Delegaci√≥n</th><th>Distrito</th></tr></thead><tbody>`;
            students.forEach(s=>{
                html += `<tr><td>${s.name}</td><td>${s.school}</td><td>${s.delegation}</td><td>${s.district||''}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        });
        content.innerHTML = html || '<div class="alert alert-warning">No hay asignaciones publicadas.</div>';
        document.getElementById('assignmentsModal').style.display='block';
    }).catch(()=>hideLoading());
}

function clearAllAssignments() {
    if(!confirm('‚ö†Ô∏è ¬øEliminar TODAS las asignaciones publicadas? Esta acci√≥n no se puede deshacer.')) return;
    showLoading('Eliminando...');
    db.ref('publicAssignments').set([]).then(()=>{
        hideLoading();
        assignments=[];
        updateStats();
        closeModal('assignmentsModal');
        alert('‚úÖ Asignaciones eliminadas.');
    }).catch(e=>{ hideLoading(); alert('Error: '+e.message); });
}

// ===================== CARGAR DATOS ADMIN =====================
function loadAdminData() {
    showLoading('Cargando datos...');
    Promise.all([
        db.ref('selectedCommissions').once('value'),
        db.ref('customLimits').once('value'),
        db.ref('whatsappLinks').once('value'),
        db.ref('publicAssignments').once('value')
    ]).then(([scSnap, clSnap, waSnap, asSnap])=>{
        selectedCommissions = scSnap.val() || [];
        customLimits = clSnap.val() || {};
        whatsappLinks = waSnap.val() || {};
        assignments = asSnap.val() || [];
        updateStats();
        hideLoading();
    }).catch(()=>hideLoading());
}

function updateStats() {
    document.getElementById('statStudents').textContent = assignments.length;
    document.getElementById('statCommissions').textContent = selectedCommissions.length;
    document.getElementById('statAssignments').textContent = assignments.length;
}

// Cargar whatsappLinks p√∫blicamente para mostrar botones en b√∫squeda
db.ref('whatsappLinks').on('value', snap=>{ whatsappLinks = snap.val()||{}; });
</script>
</body>
</html>