<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MODELOS DISTRITALES 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path d="M0,0 Q300,60 600,30 T1200,0 L1200,120 L0,120 Z" fill="rgba(255,255,255,0.05)"/></svg>');
            background-size: cover;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 50px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .logo {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 50%;
            padding: 25px;
            object-fit: contain;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transition: transform 0.3s;
            display: block;
        }

        .logo:hover {
            transform: scale(1.08);
        }

        h1 {
            font-size: 3.5em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            letter-spacing: 2px;
        }

        .content {
            padding: 50px;
        }

        .section {
            margin-bottom: 40px;
            padding: 35px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            border-left: 6px solid #1a2a6c;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section h2 {
            color: #1a2a6c;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .section p {
            text-align: justify;
            line-height: 1.9;
            color: #2c3e50;
            font-size: 1.15em;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .btn {
            padding: 25px 45px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a2a6c 0%, #3a5ba0 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #b21f1f 0%, #e74c3c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 95%;
            margin: 50px auto;
            padding: 50px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5em;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .close:hover {
            color: #b21f1f;
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .form-group input {
            width: 100%;
            padding: 18px;
            border: 3px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1a2a6c;
            box-shadow: 0 0 15px rgba(26, 42, 108, 0.3);
        }

        .form-group select {
            width: 100%;
            padding: 18px;
            border: 3px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            font-size: 0.95em;
        }

        th {
            background: linear-gradient(135deg, #1a2a6c 0%, #3a5ba0 100%);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .rubric-table {
            font-size: 0.9em;
        }

        .rubric-table input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }

        .rubric-table input[type="number"]:focus {
            border-color: #1a2a6c;
        }

        .alert {
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            border-left: 5px solid;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #856404;
        }

        .commission-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .commission-item {
            padding: 20px;
            background: white;
            border: 3px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .commission-item:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .commission-item.selected {
            background: linear-gradient(135deg, #1a2a6c 0%, #3a5ba0 100%);
            color: white;
            border-color: #1a2a6c;
        }

        .file-upload-area {
            border: 4px dashed #1a2a6c;
            padding: 50px;
            text-align: center;
            border-radius: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            background: linear-gradient(135deg, #c3cfe2 0%, #f5f7fa 100%);
            border-color: #b21f1f;
        }

        .file-upload-area input {
            display: none;
        }

        .hidden {
            display: none;
        }

        .excel-example {
            margin: 25px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            border: 3px solid #fdbb2d;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .excel-table th,
        .excel-table td {
            padding: 12px;
            border: 2px solid #ddd;
            text-align: center;
        }

        .excel-table th {
            background: #fdbb2d;
            color: #2c3e50;
        }

        .rubric-header {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .score-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .total-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a2a6c;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .welcome-section {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideInDown 0.6s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-section h2 {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .welcome-section .district-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 10px;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .welcome-section p {
            font-size: 1.2em;
            line-height: 1.8;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.25);
        }

        .stat-card .stat-number {
            font-size: 3em;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }

        .stat-card .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a2a6c;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>CELIDER DISTRITALES REGISTROS</h1>
            </div>
        </div>

        <div class="content" id="mainContent">
            <div class="section">
                <h2>üìñ Misi√≥n</h2>
                <p>Fomentar el desarrollo de competencias diplom√°ticas, de liderazgo y trabajo colaborativo en los estudiantes de los distritos educativos 10-02, 10-04 y 10-06, mediante la simulaci√≥n de organismos internacionales, promoviendo el pensamiento cr√≠tico, la investigaci√≥n acad√©mica y el di√°logo constructivo para la resoluci√≥n de conflictos globales de relevancia internacional y regional.</p>
            </div>

            <div class="section">
                <h2>üéØ Visi√≥n</h2>
                <p>Ser la plataforma educativa l√≠der en la Rep√∫blica Dominicana para la formaci√≥n de j√≥venes agentes de cambio, capaces de comprender y abordar los desaf√≠os internacionales del siglo XXI, fortaleciendo valores democr√°ticos, respeto a la diversidad, promoci√≥n de la cooperaci√≥n internacional y compromiso con el desarrollo sostenible a nivel local, nacional y global.</p>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="showLogin()"><span>üîê Acceso Administradores</span></button>
                <button class="btn btn-secondary" onclick="showStudentSearch()"><span>üîç Buscar Mi Asignaci√≥n</span></button>
                <button class="btn btn-success" onclick="showCommissions()"><span>üìã Ver Comisiones Disponibles</span></button>
            </div>
        </div>

        <div class="content hidden" id="adminPanel">
            <div class="welcome-section">
                <h2>üéâ ¬°Bienvenido/a, <span id="welcomeUser"></span>!</h2>
                <div class="district-badge">üìç <span id="welcomeDistrict"></span></div>
                <p>Has ingresado exitosamente al sistema de gesti√≥n CELIDER Distritales Registros. Desde aqu√≠ podr√°s administrar las comisiones, gestionar estudiantes, configurar r√∫bricas de evaluaci√≥n y mucho m√°s.</p>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <span class="stat-number" id="statStudents">0</span>
                        <span class="stat-label">Estudiantes</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="statCommissions">0</span>
                        <span class="stat-label">Comisiones</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="statAssignments">0</span>
                        <span class="stat-label">Asignaciones</span>
                    </div>
                </div>
            </div>

            <h2 style="color: #1a2a6c; margin-bottom: 20px;">üìã Panel de Control</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="showUploadSection()"><span>üì§ Subir Lista de Estudiantes</span></button>
                <button class="btn btn-secondary" onclick="showConfigSection()"><span>‚öôÔ∏è Configurar Simulaci√≥n</span></button>
                <button class="btn btn-success" onclick="showWhatsAppLinks()"><span>üì± Gestionar Links WhatsApp</span></button>
                <button class="btn btn-primary" onclick="showRubrics()"><span>üìä Ver R√∫bricas</span></button>
                <button class="btn btn-secondary" onclick="showAssignments()"><span>üë• Ver Asignaciones</span></button>
                <button class="btn" style="background: #6c757d; color: white;" onclick="logout()"><span>üö™ Cerrar Sesi√≥n</span></button>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2>üîê Iniciar Sesi√≥n - Administradores</h2>
            <form onsubmit="login(); return false;">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="username" placeholder="Ejemplo: CUENTA1">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ejemplo: DISTRITO 10-02">
                </div>
                <div id="loginError" style="display: none; color: #b21f1f; font-weight: bold; margin-bottom: 15px; padding: 10px; background: #ffe6e6; border-radius: 8px;">
                    ‚ùå Usuario o contrase√±a incorrectos
                </div>
                <button type="submit" class="btn btn-primary"><span>Ingresar</span></button>
            </form>
        </div>
    </div>

    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('uploadModal')">&times;</span>
            <h2>üì§ Subir Lista de Estudiantes</h2>
            
            <div class="alert alert-info">
                <strong>üìã INSTRUCCIONES:</strong><br>
                El archivo Excel debe tener 3 columnas: Nombre Completo, Centro Educativo, Distrito
            </div>

            <div class="file-upload-area" onclick="document.getElementById('excelFile').click()">
                <h3>üìÅ Click aqu√≠ para seleccionar archivo Excel</h3>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
            </div>
            <div id="uploadResult"></div>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('configModal')">&times;</span>
            <h2>‚öôÔ∏è Configurar Simulaci√≥n</h2>
            <div class="commission-selector" id="commissionSelector"></div>
            <button class="btn btn-primary" onclick="saveConfiguration()"><span>üíæ Guardar</span></button>
        </div>
    </div>

    <div id="studentSearchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentSearchModal')">&times;</span>
            <h2>üîç Buscar Mi Asignaci√≥n</h2>
            <div class="form-group">
                <label>Distrito:</label>
                <select id="studentDistrict" onchange="loadStudentList()">
                    <option value="">-- Seleccionar --</option>
                    <option value="10-02">10-02</option>
                    <option value="10-04">10-04</option>
                    <option value="10-06">10-06</option>
                </select>
            </div>
            <div class="form-group">
                <label>Buscar Nombre:</label>
                <input type="text" id="studentNameSearch" placeholder="Escribe tu nombre..." onkeyup="filterStudents()">
            </div>
            <div id="studentListResult"></div>
        </div>
    </div>

    <div id="whatsappModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('whatsappModal')">&times;</span>
            <h2>üì± Gestionar Links WhatsApp</h2>
            <div id="whatsappLinksForm"></div>
            <button class="btn btn-primary" onclick="saveWhatsAppLinks()"><span>üíæ Guardar</span></button>
        </div>
    </div>

    <div id="rubricsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('rubricsModal')">&times;</span>
            <div id="rubricsContent"></div>
        </div>
    </div>

    <div id="assignmentsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignmentsModal')">&times;</span>
            <h2>üë• Asignaciones</h2>
            <div id="assignmentsContent"></div>
        </div>
    </div>

    <div id="commissionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commissionsModal')">&times;</span>
            <h2>üìã Comisiones</h2>
            <div id="commissionsContent"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2HicfJnEoNOdgjfERIgkiJ0GA260HyLA",
            authDomain: "celider-distritales-f8753.firebaseapp.com",
            databaseURL: "https://celider-distritales-f8753-default-rtdb.firebaseio.com",
            projectId: "celider-distritales-f8753",
            storageBucket: "celider-distritales-f8753.firebasestorage.app",
            messagingSenderId: "252428103373",
            appId: "1:252428103373:web:6a209f9de105f8474d0384"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const users = {
            'CUENTA1': { password: 'DISTRITO 10-02', district: '10-02' },
            'CUENTA2': { password: 'DISTRITO 10-04', district: '10-04' },
            'CUENTA3': { password: 'DISTRITO 10-06', district: '10-06' },
            'DIEGO': { password: 'REYES 123DIEGO', district: 'ADMIN' }
        };

        const commissions = [
            { id: 'fao', name: 'FAO', fullName: 'FAO - Organizaci√≥n de las Naciones Unidas para la Alimentaci√≥n y la Agricultura', topic: 'Impactos del cambio clim√°tico', min: 30, max: 60, type: 'delegaciones' },
            { id: 'oms', name: 'OMS', fullName: 'OMS - Organizaci√≥n Mundial de la Salud', topic: 'Acceso equitativo a vacunas', min: 30, max: 60, type: 'delegaciones' },
            { id: 'unicef', name: 'UNICEF', fullName: 'UNICEF - Fondo de las Naciones Unidas para la Infancia', topic: 'Protecci√≥n de derechos infantiles', min: 30, max: 60, type: 'delegaciones' },
            { id: 'uit', name: 'UIT', fullName: 'UIT - Uni√≥n Internacional de Telecomunicaciones', topic: 'Derechos digitales', min: 30, max: 60, type: 'delegaciones' },
            { id: 'unesco', name: 'UNESCO', fullName: 'UNESCO - Organizaci√≥n de las Naciones Unidas para la Educaci√≥n', topic: 'Preservaci√≥n cultural', min: 30, max: 60, type: 'delegaciones' },
            { id: 'oit', name: 'OIT', fullName: 'OIT - Organizaci√≥n Internacional del Trabajo', topic: 'Explotaci√≥n laboral infantil', min: 30, max: 60, type: 'delegaciones' },
            { id: 'bandung', name: '1955', fullName: '1955 - Conferencia de Bandung', topic: 'Descolonizaci√≥n', min: 29, max: 58, type: 'delegaciones' },
            { id: 'cij', name: 'CIJ', fullName: 'CIJ - Corte Internacional de Justicia', topic: 'Recursos naturales en disputa', min: 15, max: 15, type: 'magistrados' },
            { id: 'interpol', name: 'INTERPOL', fullName: 'INTERPOL - Organizaci√≥n Internacional de Polic√≠a Criminal', topic: 'Caso especial', min: 50, max: 50, type: 'agentes' },
            { id: 'otan', name: 'OTAN', fullName: 'OTAN - Organizaci√≥n del Tratado del Atl√°ntico Norte', topic: 'Amenazas h√≠bridas', min: 32, max: 64, type: 'delegaciones' },
            { id: 'oas', name: 'OAS', fullName: 'OAS - Organization of American States', topic: 'Electoral integrity', min: 35, max: 35, type: 'states' }
        ];

        const countries = ['Argentina', 'Brasil', 'Chile', 'Colombia', 'M√©xico', 'Per√∫', 'Venezuela', 'Ecuador', 'Bolivia', 'Paraguay', 'Uruguay', 'Costa Rica', 'Panam√°', 'Guatemala', 'Honduras', 'El Salvador', 'Nicaragua', 'Cuba', 'Rep√∫blica Dominicana', 'Hait√≠', 'Espa√±a', 'Francia', 'Alemania', 'Italia', 'Reino Unido', 'Portugal', 'Estados Unidos', 'Canad√°', 'Jap√≥n', 'China', 'India', 'Rusia', 'Australia'];

        const rubricCriteria = [
            { name: 'Investigaci√≥n acad√©mica', maxPoints: 15 },
            { name: 'Pensamiento cr√≠tico', maxPoints: 15 },
            { name: 'Oratoria', maxPoints: 10 },
            { name: 'Argumentaci√≥n', maxPoints: 10 },
            { name: 'Redacci√≥n', maxPoints: 10 },
            { name: 'Negociaci√≥n', maxPoints: 10 },
            { name: 'Resoluci√≥n de conflictos', maxPoints: 10 },
            { name: 'Liderazgo', maxPoints: 10 },
            { name: 'Colaboraci√≥n', maxPoints: 10 }
        ];

        let currentUser = null;
        let studentsData = [];
        let assignments = [];
        let selectedCommissions = [];
        let whatsappLinks = {};

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function showStudentSearch() {
            document.getElementById('studentSearchModal').style.display = 'block';
        }

        function showCommissions() {
            const content = document.getElementById('commissionsContent');
            let html = '';
            commissions.forEach((c, i) => {
                html += `
                    <div class="section">
                        <h3>${i+1}. ${c.fullName}</h3>
                        <p><strong>T√≥pico:</strong> ${c.topic}</p>
                        <p><strong>Capacidad:</strong> M√≠nimo ${c.min} - M√°ximo ${c.max} ${c.type}</p>
                    </div>
                `;
            });
            content.innerHTML = html;
            document.getElementById('commissionsModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function login() {
            const username = document.getElementById('username').value.trim().toUpperCase();
            const password = document.getElementById('password').value.trim().toUpperCase();
            const loginError = document.getElementById('loginError');

            if (users[username] && users[username].password === password) {
                currentUser = { username, district: users[username].district };
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                
                document.getElementById('welcomeUser').textContent = username;
                document.getElementById('welcomeDistrict').textContent = currentUser.district === 'ADMIN' ? 'Administrador General' : 'Distrito ' + currentUser.district;
                
                closeModal('loginModal');
                loginError.style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                loadData();
            } else {
                loginError.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showUploadSection() {
            document.getElementById('uploadModal').style.display = 'block';
        }

        function showConfigSection() {
            const selector = document.getElementById('commissionSelector');
            let html = '';
            commissions.forEach(comm => {
                const isSelected = selectedCommissions.includes(comm.id);
                html += `
                    <div class="commission-item ${isSelected ? 'selected' : ''}" onclick="toggleCommission('${comm.id}')">
                        <strong>${comm.name}</strong><br>
                        <small>Min: ${comm.min} - M√°x: ${comm.max}</small>
                        <input type="number" id="limit_${comm.id}" value="${comm.max}" min="${comm.min}" max="${comm.max}" onclick="event.stopPropagation()" style="width: 100%; margin-top: 10px; padding: 5px;">
                    </div>
                `;
            });
            selector.innerHTML = html;
            document.getElementById('configModal').style.display = 'block';
        }

        function toggleCommission(id) {
            const index = selectedCommissions.indexOf(id);
            if (index > -1) {
                selectedCommissions.splice(index, 1);
            } else {
                selectedCommissions.push(id);
            }
            showConfigSection();
        }

        function saveConfiguration() {
            if (selectedCommissions.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos una comisi√≥n');
                return;
            }
            const customLimits = {};
            selectedCommissions.forEach(id => {
                const input = document.getElementById(`limit_${id}`);
                if (input) customLimits[id] = parseInt(input.value);
            });
            
            showLoading();
            database.ref('selectedCommissions').set(selectedCommissions).then(() => {
                return database.ref('customLimits').set(customLimits);
            }).then(() => {
                hideLoading();
                alert('‚úÖ Configuraci√≥n guardada');
                closeModal('configModal');
                if (studentsData.length > 0) assignStudents();
            }).catch(error => {
                hideLoading();
                alert('Error al guardar: ' + error.message);
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading();
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        hideLoading();
                        alert('‚ùå El archivo est√° vac√≠o');
                        return;
                    }

                    const firstRow = jsonData[0];
                    if (!firstRow['Nombre Completo'] || !firstRow['Centro Educativo'] || !firstRow['Distrito']) {
                        hideLoading();
                        alert('‚ùå ERROR: Formato incorrecto. Verifica las columnas.');
                        return;
                    }

                    if (currentUser.district === 'ADMIN') {
                        studentsData = jsonData;
                    } else {
                        studentsData = jsonData.filter(row => row['Distrito'] === currentUser.district);
                        if (studentsData.length === 0) {
                            hideLoading();
                            alert(`‚ö†Ô∏è No se encontraron estudiantes del distrito ${currentUser.district}`);
                            return;
                        }
                    }

                    saveData().then(() => {
                        return assignStudents();
                    }).then(() => {
                        hideLoading();
                        document.getElementById('uploadResult').innerHTML = `
                            <div class="alert alert-info" style="margin-top: 20px;">
                                <strong>‚úÖ ARCHIVO CARGADO</strong><br>
                                üìä Total: ${studentsData.length} estudiantes
                            </div>
                        `;
                    });
                } catch (error) {
                    hideLoading();
                    alert('‚ùå ERROR: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function assignStudents() {
            return new Promise((resolve, reject) => {
                if (selectedCommissions.length === 0) {
                    alert('‚ö†Ô∏è Configura las comisiones primero');
                    reject();
                    return;
                }
                
                assignments = [];
                database.ref('customLimits').once('value').then(snapshot => {
                    const customLimits = snapshot.val() || {};
                    const activeCommissions = commissions.filter(c => selectedCommissions.includes(c.id));

                    studentsData.forEach((student, index) => {
                        const commIndex = index % activeCommissions.length;
                        const commission = activeCommissions[commIndex];
                        const limit = customLimits[commission.id] || commission.max;
                        const studentsInComm = assignments.filter(a => a.commission === commission.id).length;
                        
                        if (studentsInComm < limit) {
                            let delegation = '';
                            if (commission.type === 'magistrados') {
                                delegation = `S.E. ${student['Nombre Completo'].split(' ').pop()}`;
                            } else if (commission.type === 'agentes') {
                                delegation = `Agente ${student['Nombre Completo'].split(' ')[0]}`;
                            } else {
                                delegation = countries[Math.floor(Math.random() * countries.length)];
                            }

                            assignments.push({
                                name: student['Nombre Completo'],
                                school: student['Centro Educativo'],
                                district: student['Distrito'],
                                commission: commission.id,
                                commissionName: commission.fullName,
                                delegation: delegation,
                                attendance: '',
                                scores: {},
                                total: 0,
                                regional: false
                            });
                        }
                    });
                    
                    return saveData();
                }).then(() => {
                    updateStats();
                    alert(`‚úÖ ${assignments.length} estudiantes asignados`);
                    resolve();
                }).catch(error => {
                    alert('Error: ' + error.message);
                    reject(error);
                });
            });
        }

        function showWhatsAppLinks() {
            const form = document.getElementById('whatsappLinksForm');
            let html = '';
            const activeCommissions = commissions.filter(c => selectedCommissions.includes(c.id));
            activeCommissions.forEach(comm => {
                const currentLink = whatsappLinks[comm.id] || '';
                html += `<div class="form-group"><label>${comm.name}:</label><input type="url" id="wa_${comm.id}" value="${currentLink}" placeholder="https://chat.whatsapp.com/..."></div>`;
            });
            form.innerHTML = html;
            document.getElementById('whatsappModal').style.display = 'block';
        }

        function saveWhatsAppLinks() {
            const activeCommissions = commissions.filter(c => selectedCommissions.includes(c.id));
            activeCommissions.forEach(comm => {
                const input = document.getElementById(`wa_${comm.id}`);
                if (input) whatsappLinks[comm.id] = input.value;
            });
            
            showLoading();
            database.ref('whatsappLinks').set(whatsappLinks).then(() => {
                hideLoading();
                alert('‚úÖ Links guardados');
                closeModal('whatsappModal');
            }).catch(error => {
                hideLoading();
                alert('Error: ' + error.message);
            });
        }

        function updateAttendance(name, commId, value) {
            const assignment = assignments.find(a => a.name === name && a.commission === commId);
            if (assignment) {
                assignment.attendance = value;
                saveData();
            }
        }

        function updateScore(name, commId, criterion, value) {
            const assignment = assignments.find(a => a.name === name && a.commission === commId);
            if (assignment) {
                if (!assignment.scores) assignment.scores = {};
                assignment.scores[criterion] = parseFloat(value) || 0;
                
                let total = 0;
                rubricCriteria.forEach(crit => {
                    total += assignment.scores[crit.name] || 0;
                });
                assignment.total = total;
                
                document.getElementById(`total_${name}_${commId}`).textContent = total.toFixed(1);
                saveData();
            }
        }

        function toggleRegional(name, commId) {
            const assignment = assignments.find(a => a.name === name && a.commission === commId);
            if (assignment) {
                assignment.regional = !assignment.regional;
                saveData();
            }
        }

        function showRubrics() {
            const content = document.getElementById('rubricsContent');
            let html = '';
            const activeCommissions = commissions.filter(c => selectedCommissions.includes(c.id));

            activeCommissions.forEach(comm => {
                let commStudents;
                if (currentUser.district === 'ADMIN') {
                    commStudents = assignments.filter(a => a.commission === comm.id);
                } else {
                    commStudents = assignments.filter(a => a.commission === comm.id && a.district === currentUser.district);
                }
                
                html += `
                    <div class="rubric-header">
                        <h2>üìä R√öBRICA DE EVALUACI√ìN</h2>
                        <h3>${comm.fullName}</h3>
                    </div>
                    
                    <div class="section">
                        <table class="rubric-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Delegaci√≥n</th>
                                    ${currentUser.district === 'ADMIN' ? '<th>Distrito</th>' : ''}
                                    <th>P y V</th>
                                    <th>P</th>
                                    <th>A</th>
                                    ${rubricCriteria.map(c => `<th>${c.name}<br>(${c.maxPoints})</th>`).join('')}
                                    <th>Total</th>
                                    <th>Regional</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                commStudents.forEach(student => {
                    const attendance = student.attendance || '';
                    html += `
                        <tr>
                            <td><strong>${student.name}</strong></td>
                            <td>${student.delegation}</td>
                            ${currentUser.district === 'ADMIN' ? `<td>${student.district}</td>` : ''}
                            <td><input type="radio" name="att_${student.name}_${comm.id}" value="PRESENTE Y VOTANDO" ${attendance === 'PRESENTE Y VOTANDO' ? 'checked' : ''} onchange="updateAttendance('${student.name}', '${comm.id}', 'PRESENTE Y VOTANDO')"></td>
                            <td><input type="radio" name="att_${student.name}_${comm.id}" value="PRESENTE" ${attendance === 'PRESENTE' ? 'checked' : ''} onchange="updateAttendance('${student.name}', '${comm.id}', 'PRESENTE')"></td>
                            <td><input type="radio" name="att_${student.name}_${comm.id}" value="AUSENTE" ${attendance === 'AUSENTE' ? 'checked' : ''} onchange="updateAttendance('${student.name}', '${comm.id}', 'AUSENTE')"></td>
                    `;

                    rubricCriteria.forEach(crit => {
                        const score = (student.scores && student.scores[crit.name]) || '';
                        html += `<td><input type="number" class="score-input" min="0" max="${crit.maxPoints}" step="0.5" value="${score}" onchange="updateScore('${student.name}', '${comm.id}', '${crit.name}', this.value)"></td>`;
                    });

                    html += `
                            <td class="total-score" id="total_${student.name}_${comm.id}">${student.total || 0}</td>
                            <td><input type="checkbox" ${student.regional ? 'checked' : ''} onchange="toggleRegional('${student.name}', '${comm.id}')" style="width: 25px; height: 25px;"></td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div><hr style="margin: 40px 0;">`;
            });

            html += `
                <div class="download-buttons">
                    <button class="btn btn-success" onclick="saveRubrics()"><span>üíæ Guardar</span></button>
                    <button class="btn btn-primary" onclick="downloadRubricsExcel()"><span>üì• Excel</span></button>
                </div>
            `;

            content.innerHTML = html;
            document.getElementById('rubricsModal').style.display = 'block';
        }

        function saveRubrics() {
            saveData().then(() => {
                alert('‚úÖ R√∫bricas guardadas');
            });
        }

        function downloadRubricsExcel() {
            const wb = XLSX.utils.book_new();
            const activeCommissions = commissions.filter(c => selectedCommissions.includes(c.id));

            activeCommissions.forEach(comm => {
                let commStudents;
                if (currentUser.district === 'ADMIN') {
                    commStudents = assignments.filter(a => a.commission === comm.id);
                } else {
                    commStudents = assignments.filter(a => a.commission === comm.id && a.district === currentUser.district);
                }

                const data = [
                    ['R√öBRICA DE EVALUACI√ìN'],
                    [comm.fullName],
                    [],
                    ['Nombre', 'Delegaci√≥n', 'Distrito', 'Asistencia', ...rubricCriteria.map(c => c.name), 'Total', 'Regional']
                ];

                commStudents.forEach(student => {
                    const row = [
                        student.name,
                        student.delegation,
                        student.district,
                        student.attendance || '',
                        ...rubricCriteria.map(crit => (student.scores && student.scores[crit.name]) || 0),
                        student.total || 0,
                        student.regional ? 'S√ç' : 'NO'
                    ];
                    data.push(row);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, comm.name);
            });

            XLSX.writeFile(wb, `Rubricas_${currentUser.district}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function showAssignments() {
            const content = document.getElementById('assignmentsContent');
            let html = '';
            const activeCommissions = commissions.filter(c => selectedCommissions.includes(c.id));

            activeCommissions.forEach(comm => {
                const commStudents = assignments.filter(a => a.commission === comm.id);
                html += `
                    <div class="section">
                        <h3>${comm.fullName} (${commStudents.length})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Centro Educativo</th>
                                    <th>Delegaci√≥n</th>
                                    <th>Distrito</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                commStudents.forEach(student => {
                    html += `<tr><td>${student.name}</td><td>${student.school}</td><td>${student.delegation}</td><td>${student.district}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            });

            content.innerHTML = html || '<p class="alert alert-warning">No hay asignaciones</p>';
            document.getElementById('assignmentsModal').style.display = 'block';
        }

        function loadStudentList() {
            const district = document.getElementById('studentDistrict').value;
            if (!district) {
                document.getElementById('studentListResult').innerHTML = '';
                return;
            }
            const districtStudents = assignments.filter(a => a.district === district);
            if (districtStudents.length === 0) {
                document.getElementById('studentListResult').innerHTML = `<div class="alert alert-warning">No hay estudiantes del distrito ${district}</div>`;
                return;
            }
            displayStudentList(districtStudents);
        }

        function filterStudents() {
            const district = document.getElementById('studentDistrict').value;
            const searchTerm = document.getElementById('studentNameSearch').value.toLowerCase();
            if (!district) return;
            const districtStudents = assignments.filter(a => a.district === district && a.name.toLowerCase().includes(searchTerm));
            displayStudentList(districtStudents);
        }

        function displayStudentList(students) {
            let html = `<table><thead><tr><th>Nombre</th><th>Centro</th><th>Comisi√≥n</th><th>Delegaci√≥n</th><th>WhatsApp</th></tr></thead><tbody>`;
            students.forEach(student => {
                const waLink = whatsappLinks[student.commission];
                const waButton = waLink ? `<a href="${waLink}" target="_blank" class="btn btn-success" style="padding: 8px 15px; font-size: 0.9em;">üì± Unirse</a>` : '<span style="color: #999;">No disponible</span>';
                html += `<tr><td><strong>${student.name}</strong></td><td>${student.school}</td><td>${student.commissionName.split(' - ')[0]}</td><td>${student.delegation}</td><td>${waButton}</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('studentListResult').innerHTML = html;
        }

        function saveData() {
            return new Promise((resolve, reject) => {
                const district = currentUser.district === 'ADMIN' ? 'all' : currentUser.district;
                const updates = {};
                updates[`districts/${district}/students`] = studentsData;
                updates[`districts/${district}/assignments`] = assignments;
                
                database.ref().update(updates).then(() => {
                    updateStats();
                    resolve();
                }).catch(error => {
                    console.error('Error saving:', error);
                    reject(error);
                });
            });
        }

        function loadData() {
            showLoading();
            const district = currentUser.district === 'ADMIN' ? 'all' : currentUser.district;
            
            Promise.all([
                database.ref(`districts/${district}/students`).once('value'),
                database.ref(`districts/${district}/assignments`).once('value'),
                database.ref('selectedCommissions').once('value'),
                database.ref('whatsappLinks').once('value')
            ]).then(([studentsSnap, assignmentsSnap, commissionsSnap, linksSnap]) => {
                studentsData = studentsSnap.val() || [];
                assignments = assignmentsSnap.val() || [];
                selectedCommissions = commissionsSnap.val() || [];
                whatsappLinks = linksSnap.val() || {};
                updateStats();
                hideLoading();
            }).catch(error => {
                console.error('Error loading:', error);
                hideLoading();
            });
        }

        function updateStats() {
            document.getElementById('statStudents').textContent = studentsData.length;
            document.getElementById('statCommissions').textContent = selectedCommissions.length;
            document.getElementById('statAssignments').textContent = assignments.length;
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>